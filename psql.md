# PSQL 

## commande de conexion PSQL 

| Commande / Option                                  | Description                                                                 |
|----------------------------------------------------|-----------------------------------------------------------------------------|
| `psql`                                             | Lance l‚Äôinterface PSQL avec l‚Äôutilisateur courant                          |
| `psql -U utilisateur`                              | Connexion √† PostgreSQL avec un utilisateur sp√©cifique                      |
| `psql -d nom_base`                                 | Se connecter directement √† une base de donn√©es                             |
| `psql -h h√¥te -p port -U utilisateur -d base`      | Connexion compl√®te (avec host, port, user, db)                             |
| `psql -W`                                          | Demande le mot de passe manuellement                                       |
| `\c nom_base utilisateur`                          | Changer de base de donn√©es (et/ou utilisateur) en session                  |
| `\conninfo`                                        | Affiche les infos de connexion actuelles                                   |
| `psql "postgresql://user:pass@host:port/db"`       | Connexion via URI (tr√®s pratique pour les scripts)                         |
| `PGPASSWORD=motdepasse psql -U user -d db`         | Connexion en ligne de commande avec mdp temporaire                         |
| `psql --help`                                      | Liste toutes les options de connexion                                      |

| Commande / Action                                  | Description                                                                 |
|----------------------------------------------------|-----------------------------------------------------------------------------|
| `sudo -i -u postgres`                              | Se connecter √† l‚Äôutilisateur syst√®me `postgres`                            |
| `psql` (dans postgres)                             | Lancer le shell PSQL en tant que superutilisateur                          |
| `psql -U postgres`                                 | Se connecter directement √† PostgreSQL en tant que superuser                |
| `CREATE USER nom WITH PASSWORD 'mdp';`             | Cr√©er un utilisateur avec mot de passe                                     |
| `CREATE ROLE nom;`                                 | Cr√©er un r√¥le vide (pas de login par d√©faut)                               |
| `ALTER ROLE nom WITH LOGIN PASSWORD 'mdp';`        | Donner le droit de connexion √† un r√¥le                                     |
| `GRANT ALL PRIVILEGES ON DATABASE db TO user;`     | Donner tous les droits sur une base √† un utilisateur                       |
| `\du`                                              | Lister les r√¥les/utilisateurs                                               |
| `DROP USER nom;`                                   | Supprimer un utilisateur                                                   |
| `ALTER USER nom WITH SUPERUSER;`                   | Donner les droits superuser √† un utilisateur                               |
| `\password nom_utilisateur`                        | Changer le mot de passe d‚Äôun utilisateur                                   |



## les commande PSQL

| Commande                          | Description                                                                 |
|-----------------------------------|-----------------------------------------------------------------------------|
| `\l` ou `\list`                   | Liste toutes les bases de donn√©es                                           |
| `\c nom_de_la_base`               | Se connecter √† une base de donn√©es                                          |
| `\dt`                             | Liste toutes les tables de la base de donn√©es courante                      |
| `\d`                              | Liste toutes les relation entre table                                       |
| `\d nom_table`                    | Affiche les d√©tails d'une table (colonnes, types, cl√©s, etc.)               |
| `\du`                             | Liste les r√¥les (utilisateurs)                                              |
| `\q`                              | Quitter PSQL                                                                |
| `\?`                              | Affiche l‚Äôaide des commandes internes de PSQL                               |
| `\conninfo`                       | Affiche les infos de connexion √† la base actuelle                           |
| `CREATE DATABASE nom_base;`       | Cr√©e une nouvelle base de donn√©es                                           |
| `DROP DATABASE nom_base;`         | Supprime une base de donn√©es                                                |
| `CREATE TABLE nom (...);`         | Cr√©e une nouvelle table                                                     |
| `DROP TABLE nom;`                 | Supprime une table                                                          |
| `INSERT INTO table VALUES (...);` | Ins√®re des donn√©es dans une table                                           |
| `SELECT * FROM table;`            | S√©lectionne toutes les donn√©es d‚Äôune table                                  |
| `UPDATE table SET ... WHERE ...;` | Modifie des donn√©es                                                         |
| `DELETE FROM table WHERE ...;`    | Supprime des donn√©es                                                        |
| `ALTER TABLE ...`                 | Modifie une table (ajout de colonne, renommage, etc.)                       |
| `\i chemin/fichier.sql`           | Ex√©cute un script SQL depuis un fichier                                     |
| `\e`                              | Ouvre l‚Äô√©diteur par d√©faut pour √©crire une requ√™te SQL                      |
| `\timing`                         | Active/d√©sactive le chronom√©trage des requ√™tes                              |
| `\watch [secondes]`               | Ex√©cute une commande √† intervalle r√©gulier                                  |


## sauvegarde 

| Type de sauvegarde                | Commande exemple                                                    | Description                                                                       |
|----------------------------       |---------------------------------------------------------------      |-----------------------------------------------------------------------------      |
| üîÅ Compl√®te (structure + donn√©es) | `pg_dump -U user -d ma_base > full.sql`                             | Sauvegarde toute la base : tables, donn√©es, index, etc.                           |
| üìê Structure uniquement           | `pg_dump -U user -d ma_base --schema-only > structure.sql`          | Sauvegarde uniquement les `CREATE TABLE`, `CREATE INDEX`, etc.                    |
| üíæ Donn√©es uniquement             | `pg_dump -U user -d ma_base --data-only > data.sql`                 | Ne contient que les `INSERT INTO`, pas les sch√©mas.                               |
| üéØ Table sp√©cifique               | `pg_dump -U user -d ma_base -t nom_table > table.sql`               | Sauvegarde uniquement une table sp√©cifique (structure + donn√©es).                 |
| üß© Format custom (compress√©)      | `pg_dump -U user -d ma_base -F c -f base.backup`                    | Format binaire/restaurable avec `pg_restore`, utile pour les gros dumps.          |
| üß† Multi-table personnalis√©e      | `pg_dump -U user -d ma_base -t table1 -t table2 > multi.sql`        | Exporte plusieurs tables sp√©cifiques.                                             |

## restaure
| Type de fichier / sauvegarde        | Commande de restauration                                                                 | Description                                                                 |
|------------------------------------|-------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------|
| ‚úÖ Base compl√®te (.sql)            | `psql -U user -d base < fichier.sql`                                                      | Restaure toute la base (structure + donn√©es)                               |
| üß© Format custom (.backup)         | `pg_restore -U user -d base fichier.backup`                                               | Restaure depuis un dump compress√© (format `-F c`)                          |
| üìê Structure uniquement (.sql)     | `psql -U user -d base < structure.sql`                                                    | Restaure uniquement les tables/sch√©ma                                      |
| üíæ Donn√©es uniquement (.sql)       | `psql -U user -d base < data.sql`                                                         | Restaure uniquement les donn√©es (`INSERT INTO ...`)                        |
| üéØ Table sp√©cifique (SQL)          | `psql -U user -d base < table_backup.sql`                                                 | Restaure une seule table (structure + donn√©es)                             |
| ‚ùå Supprimer une table avant       | `DROP TABLE nom_table;`                                                                   | Optionnel : si tu veux restaurer une table en la rempla√ßant compl√®tement   |
| üîß Recr√©er une base vide           | `createdb -U user nom_base`                                                               | N√©cessaire avant `pg_restore` si la base n'existe pas encore               |
| üì¶ pg_restore : structure seule    | `pg_restore -U user -d base --schema-only fichier.backup`                                | Restaure uniquement les `CREATE TABLE`, etc. depuis un `.backup`           |
| üì¶ pg_restore : donn√©es seules     | `pg_restore -U user -d base --data-only fichier.backup`                                  | Restaure uniquement les donn√©es depuis un `.backup`                        |
| üîÅ pg_restore : table sp√©cifique   | `pg_restore -U user -d base -t nom_table fichier.backup`                                 | Restaure une table pr√©cise depuis un dump custom                           |

### cas d'erreure lors de restauration 

| Erreur                            | Cause probable                              | Solution recommand√©e                             | Commande √† utiliser                                             |
|----------------------------------|---------------------------------------------|--------------------------------------------------|-----------------------------------------------------------------|
| Table already exists             | La table est d√©j√† pr√©sente dans la base     | Supprimer la table avant de restaurer            | `DROP TABLE nom_table;`                                         |
| Duplicate key violates unique... | Donn√©es d√©j√† pr√©sentes ou conflits          | Nettoyer les donn√©es ou utiliser une base vierge | `TRUNCATE TABLE nom_table;` ou restaurer dans base temporaire   |
| Role does not exist              | Le r√¥le utilis√© dans le dump n'existe pas   | Cr√©er le r√¥le avec les bons droits               | `CREATE ROLE nom WITH LOGIN PASSWORD 'xxx';`                    |
| Permission denied                | Pas les droits suffisants                   | Utiliser `postgres` ou ajuster les privil√®ges    | `GRANT ALL PRIVILEGES ON DATABASE ma_base TO mon_user;`         |
| Database already exists          | Tu essayes de recr√©er une base existante    | Supprimer la base ou en utiliser une autre       | `DROP DATABASE ma_base;` ou `pg_restore -d autre_base fichier`  |
| Foreign key violation            | Conflit d‚Äôint√©grit√© entre tables            | Restaurer les tables dans le bon ordre           | `pg_restore -t table1 -t table2 ... fichier.backup`             |
| Syntax error in SQL              | Mauvais format ou fichier dump corrompu     | V√©rifier ou r√©g√©n√©rer le dump                    | Ouvrir le fichier `.sql` ou refaire le dump avec `pg_dump`      |

# Les droit 

| Type d'objet      | Droits disponibles                                                                                 | Exemple `GRANT`                                                                 |
|-------------------|----------------------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| **Table**         | SELECT, INSERT, UPDATE, DELETE, TRUNCATE, REFERENCES, TRIGGER                                     | GRANT SELECT, UPDATE ON table_name TO user_name;                                |
| **Colonne (table)**| UPDATE, INSERT (sur colonnes sp√©cifiques uniquement)                                              | GRANT UPDATE (col1, col2) ON table_name TO user_name;                           |
| **Vue**           | SELECT, UPDATE, INSERT, DELETE (si la vue le permet)                                              | GRANT SELECT ON view_name TO user_name;                                         |
| **S√©quence**      | SELECT (voir valeur), UPDATE (changer valeur), USAGE (utiliser dans nextval)                      | GRANT USAGE, SELECT ON sequence_name TO user_name;                              |
| **Base de donn√©es**| CONNECT, CREATE, TEMP                                                                             | GRANT CONNECT ON DATABASE db_name TO user_name;                                 |
| **Sch√©ma**        | USAGE (acc√®s), CREATE (cr√©er objets dans le sch√©ma)                                               | GRANT USAGE, CREATE ON SCHEMA schema_name TO user_name;                         |
| **Fonction**      | EXECUTE                                                                                           | GRANT EXECUTE ON FUNCTION func_name(args) TO user_name;                         |
| **Langage**       | USAGE                                                                                             | GRANT USAGE ON LANGUAGE plpgsql TO user_name;                                   |
| **Type**          | USAGE                                                                                             | GRANT USAGE ON TYPE custom_type TO user_name;                                   |
| **Foreign Table** | SELECT, INSERT, UPDATE, DELETE                                                                    | GRANT SELECT ON foreign_table_name TO user_name;                                |
| **Aggregate**     | EXECUTE                                                                                           | GRANT EXECUTE ON AGGREGATE agg_name(args) TO user_name;                         |
| **All objets d‚Äôun type**| ALL [PRIVILEGES]                                                                            | GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO user_name;              |


## üîπ Op√©rateurs de comparaison

| Op√©rateur   | Description               | Exemple                   |
|-------------|---------------------------|---------------------------|
| `=`         | √âgal √†                    | `age = 30`                |
| `!=` ou `<>`| Diff√©rent de              | `nom <> 'Alice'`          |
| `>`         | Sup√©rieur √†               | `salaire > 2000`          |
| `<`         | Inf√©rieur √†               | `quantit√© < 100`          |
| `>=`        | Sup√©rieur ou √©gal √†       | `note >= 10`              |
| `<=`        | Inf√©rieur ou √©gal √†       | `date <= '2023-12-31'`    |

## üîπ Op√©rateurs logiques

| Op√©rateur | Description         | Exemple                              |
|----------|---------------------|--------------------------------------|
| `AND`    | ET logique           | `age > 18 AND ville = 'Paris'`       |
| `OR`     | OU logique           | `ville = 'Paris' OR ville = 'Lyon'`  |
| `NOT`    | N√©gation             | `NOT (age < 18)`                     |

## üîπ Op√©rateurs arithm√©tiques

| Op√©rateur | Description     | Exemple               |
|----------|-----------------|------------------------|
| `+`      | Addition         | `prix + taxe`          |
| `-`      | Soustraction     | `total - remise`       |
| `*`      | Multiplication   | `quantit√© * prix`      |
| `/`      | Division         | `salaire / 12`         |
| `%`      | Modulo (reste)   | `age % 2`              |

## üîπ Op√©rateurs sp√©ciaux

| Op√©rateur     | Description                             | Exemple                           |
|---------------|-----------------------------------------|-----------------------------------|
| `BETWEEN`     | Entre deux valeurs incluses             | `age BETWEEN 18 AND 30`          |
| `IN`          | Dans une liste de valeurs               | `ville IN ('Paris', 'Lyon')`     |
| `LIKE`        | Recherche avec motif                    | `nom LIKE 'A%'`                  |
| `IS NULL`     | Est NULL                                | `adresse IS NULL`                |
| `IS NOT NULL` | N‚Äôest pas NULL                          | `adresse IS NOT NULL`            |
| `EXISTS`      | V√©rifie l‚Äôexistence d‚Äôun sous-ensemble  | `EXISTS (SELECT 1 FROM ...)`     |

## üîπ Fonctions d'agr√©gation SQL

| Fonction   | Description                                      | Exemple                                 |
|------------|--------------------------------------------------|------------------------------------------|
| `COUNT()`  | Compte le nombre de lignes                       | `SELECT COUNT(*) FROM Produit;`          |
| `SUM()`    | Calcule la somme d'une colonne                   | `SELECT SUM(PrixUnit) FROM Produit;`     |
| `MAX()`    | Renvoie la valeur maximale d'une colonne         | `SELECT MAX(PrixUnit) FROM Produit;`     |
| `MIN()`    | Renvoie la valeur minimale d'une colonne         | `SELECT MIN(PrixUnit) FROM Produit;`     |
| `AVG()`    | Calcule la moyenne d'une colonne                 | `SELECT AVG(PrixUnit) FROM Produit;`     |


